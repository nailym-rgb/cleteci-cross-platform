version: 1
frontend:
  phases:
    # 1. Fase de Provisionamiento: Configura el entorno
    preBuild:
      commands:
        # Clona el SDK de Flutter
        - git clone https://github.com/flutter/flutter.git -b stable $HOME/flutter
        # Añade Flutter a la PATH
        - export PATH="$PATH:$HOME/flutter/bin"
        - mkdir -p assets # Asegura que la carpeta assets exista
        # Crea el archivo .env con las variables de Amplify
        - echo "FIREBASE_API_KEY=$FIREBASE_API_KEY" > assets/env.vars
        - echo "FIREBASE_APP_ID=$FIREBASE_APP_ID" >> assets/env.vars
        - echo "GOOGLE_OAUTH_CLIENT_ID=$GOOGLE_OAUTH_CLIENT_ID" >> assets/env.vars
        # Verifica la instalación de Flutter
        - flutter doctor
        # Habilita el soporte para web
        - flutter config --enable-web
        # Instalar Node.js para Cypress (E2E tests)
        - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
        - apt-get install -y nodejs
    # 2. Fase de Compilación: Compila el proyecto
    build:
      commands:
        # Asegura que Flutter esté en la PATH
        - export PATH="$PATH:$HOME/flutter/bin"
        # Obtiene las dependencias de pubspec.yaml
        - flutter pub get
        # Compila la aplicación web para producción
        - flutter build web --release --pwa-strategy none
    # 3. Fase de Pruebas E2E: Ejecuta pruebas antes de desplegar
    test:
      commands:
        # Instalar dependencias de Cypress
        - npm install
        # Activar dhttpd globalmente para servir la app
        - flutter pub global activate dhttpd
        # Iniciar servidor web en background
        - nohup flutter pub global run dhttpd --path build/web --port 8080 &
        - sleep 10  # Esperar que el servidor inicie completamente
        # Ejecutar pruebas E2E (sin grabación para evitar timeouts)
        - npm run cy:run -- --record false --config video=false
  # 4. Artefactos: Indica qué archivos subir al hosting
  artifacts:
    # El directorio donde 'flutter build web' guarda el resultado
    baseDirectory: build/web
    files:
      - '**/*'
  cache:
    paths:
      - $HOME/flutter
      - node_modules